<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinic Sales Analytics Dashboard (Pro)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- CSS Variables & Theme --- */
        :root {
            --primary-color: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%);
            --accent-color: #ec4899;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-radius: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --font-family: 'Prompt', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            /* Mesh Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* --- Layout Container --- */
        .dashboard-container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: rgba(255, 255, 255, 0.85);
            border-radius: 24px; 
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(12px);
            overflow: hidden; 
        }

        /* --- Header --- */
        .header { 
            background: var(--primary-gradient); 
            color: white; 
            padding: 40px 30px; 
            text-align: center; 
            position: relative;
        }
        
        .header h1 { 
            font-size: 2.2em; 
            font-weight: 700; 
            margin-bottom: 10px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        
        .header p { 
            font-size: 1.1em; 
            opacity: 0.95; 
            font-weight: 300; 
        }

        /* --- Controls Bar --- */
        .controls-container { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #e5e7eb; 
            display: flex; 
            gap: 20px; 
            align-items: flex-end; 
            flex-wrap: wrap; 
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 0.85em; font-weight: 600; color: var(--text-muted); }
        
        .input-group input, .input-group select { 
            padding: 10px 14px; 
            border: 1px solid #d1d5db; 
            border-radius: 10px; 
            font-size: 14px; 
            font-family: var(--font-family);
            background-color: #f9fafb;
            transition: all 0.2s;
        }
        .input-group input:focus { 
            border-color: var(--primary-color); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); 
            background-color: white;
        }

        .compare-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 15px;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            height: 42px;
        }
        
        #compareDateRange { 
            display: none; 
            gap: 15px; 
            animation: fadeIn 0.3s ease;
        }

        /* --- Buttons --- */
        .btn-group { margin-left: auto; display: flex; gap: 10px; }
        
        button {
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-family);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary { 
            background: var(--text-main); 
            color: white; 
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            background: #000;
        }

        .btn-magic { 
            background: var(--secondary-gradient); 
            color: white; 
        }
        .btn-magic:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); 
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 6px;
            background: #eef2ff;
            color: var(--primary-color);
            border: 1px solid #e0e7ff;
        }
        .btn-sm:hover {
            background: #e0e7ff;
        }

        button:disabled { 
            background: #e5e7eb; 
            color: #9ca3af; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }

        /* --- Main Content --- */
        .main-content { padding: 30px; }
        
        .initial-state { 
            text-align: center; 
            padding: 80px 20px; 
            color: var(--text-muted); 
            background: white;
            border-radius: 20px;
            border: 2px dashed #e5e7eb;
        }
        .initial-state i { font-size: 3em; margin-bottom: 20px; color: #d1d5db; }

        /* --- Stats Grid --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px; 
        }
        
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-sm); 
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow-md); 
        }
        
        .stat-value { 
            font-size: clamp(1.4rem, 2vw, 1.8rem); 
            font-weight: 700; 
            color: var(--text-main); 
            margin-bottom: 8px; 
            line-height: 1.4;
            word-wrap: break-word;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .stat-label { 
            font-size: 0.9em; 
            color: var(--text-muted); 
            margin-top: auto;
        }
        
        .badge { 
            font-size: 0.6em; 
            padding: 4px 8px; 
            border-radius: 12px; 
            font-weight: 600;
            vertical-align: middle;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .badge.pos { background: #dcfce7; color: #166534; }
        .badge.neg { background: #fee2e2; color: #991b1b; }
        .badge.neu { background: #f3f4f6; color: #4b5563; }

        /* --- Charts Section --- */
        .section-header { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }
        .section-title { font-size: 1.4em; font-weight: 700; color: var(--text-main); }
        
        .charts-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); 
            gap: 30px; 
            margin-bottom: 40px; 
        }
        
        .chart-box { 
            background: white; 
            padding: 25px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-sm); 
            height: 400px;
            position: relative;
        }
        
        /* --- Tables --- */
        .table-wrapper {
            background: white;
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-sm); 
            overflow: hidden; 
            margin-bottom: 40px;
        }
        
        .table-header {
            padding: 20px 25px;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h3 { font-size: 1.1em; font-weight: 700; }

        .table-scroll { max-height: 500px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; }
        th { 
            background: #f9fafb; 
            padding: 15px 20px; 
            text-align: left; 
            font-weight: 600; 
            color: var(--text-muted); 
            font-size: 0.9em; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        td { 
            padding: 14px 20px; 
            border-bottom: 1px solid #f3f4f6; 
            font-size: 0.95em; 
        }
        tr:hover td { background-color: #f8fafc; }

        .clickable { 
            color: var(--primary-color); 
            cursor: pointer; 
            font-weight: 500; 
            text-decoration: underline; 
            text-decoration-color: transparent;
            transition: text-decoration-color 0.2s;
        }
        .clickable:hover { text-decoration-color: var(--primary-color); }

        /* --- Insights Box --- */
        .insights-box {
            background: #eff6ff;
            border-left: 5px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            color: #1e3a8a;
        }

        /* --- Modal --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.show { opacity: 1; }
        
        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            width: 90%; max-width: 1000px;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transform: translateY(20px); transition: transform 0.3s;
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .modal.show .modal-content { transform: translateY(0); }
        
        .modal-header { padding: 20px 30px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; overflow-y: auto; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid #e5e7eb; text-align: right; background: #f9fafb; border-radius: 0 0 20px 20px; }
        
        .close-btn { font-size: 1.5em; color: #9ca3af; cursor: pointer; }
        .close-btn:hover { color: #ef4444; }

        #aiSummaryText { width: 100%; height: 300px; padding: 15px; border: 1px solid #d1d5db; border-radius: 10px; font-family: monospace; line-height: 1.6; resize: vertical; }

        /* Loading */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: var(--text-muted); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .controls-container { flex-direction: column; align-items: stretch; }
            .btn-group { width: 100%; margin-top: 10px; }
            .btn-group button { flex: 1; justify-content: center; }
            .charts-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fa-solid fa-chart-line"></i> Clinic Sales Dashboard</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°</p>
        </div>

        <!-- Controls -->
        <div class="controls-container">
            <div class="input-group" style="flex: 2; min-width: 280px;">
                <label for="fileInput"><i class="fa-regular fa-file-excel"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≤‡∏¢</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            </div>

            <div class="input-group">
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <input type="date" id="startDate" disabled>
            </div>

            <div class="input-group">
                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                <input type="date" id="endDate" disabled>
            </div>

            <div class="compare-wrapper">
                <input type="checkbox" id="compareToggle" disabled>
                <label for="compareToggle" style="font-size: 0.9em; cursor: pointer;">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</label>
            </div>

            <div id="compareDateRange">
                <div class="input-group">
                    <label>‡πÄ‡∏£‡∏¥‡πà‡∏° (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</label>
                    <input type="date" id="compareStartDate" disabled>
                </div>
                <div class="input-group">
                    <label>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</label>
                    <input type="date" id="compareEndDate" disabled>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-primary" id="filterButton" onclick="filterData()" disabled>
                    <i class="fa-solid fa-filter"></i> ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
                <button class="btn-primary" id="exportPdfButton" onclick="exportToPDF()" disabled>
                    <i class="fa-solid fa-file-pdf"></i> ‡πÅ‡∏Ñ‡∏õ‡∏£‡∏π‡∏õ PDF
                </button>
                <button class="btn-magic" id="aiSummaryButton" onclick="generateAISummary()" disabled>
                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Summary
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Initial State -->
            <div id="initialState" class="initial-state">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h2>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h2>
                <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls, .csv</p>
            </div>

            <div id="dashboardContent" style="display: none;">
                <!-- Section 1: Overview Stats -->
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-chart-pie"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">-</div>
                        <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div>
                        <div class="icon-bg"><i class="fa-solid fa-baht-sign"></i></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVisits">-</div>
                        <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Visit (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCustomers">-</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ñ‡∏ô)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="newCustomers" style="color:var(--primary-color)">-</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</div>
                    </div>
                    <!-- ADDED PAYING CUSTOMERS CARD -->
                    <div class="stat-card">
                        <div class="stat-value" id="payingCustomers">-</div>
                        <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏Ñ‡∏ô)</div>
                    </div>
                    <!-- END ADDED CARD -->
                    <div class="stat-card">
                        <div class="stat-value" id="repeatRate">-</div>
                        <div class="stat-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° (Repeat Rate)</div>
                    </div>
                </div>

                <!-- Section 2: Charts -->
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-chart-area"></i> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                </div>

                <div class="charts-grid">
                    <div class="chart-box">
                        <h3>üìà ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>
                        <canvas id="dailySalesChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>üõçÔ∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>üìÖ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>üéØ RFM Analysis (‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</h3>
                        <canvas id="recencyFrequencyPlot"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>üìä Performance Matrix (Top 10 Items)</h3>
                        <canvas id="performanceMatrixChart"></canvas>
                    </div>
                     <div class="chart-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 style="margin:0;">üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
                            <button class="btn-sm" onclick="exportFrequencyData()">
                                <i class="fa-solid fa-list-ol"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                        <canvas id="frequencyDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Section 3: RFM Insights -->
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-users-gear"></i> ‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (RFM Insight)</div>
                </div>
                <div id="rfmInsightsContainer"></div>

                <!-- Section 4: Tables -->
                <div class="section-header" style="margin-top: 40px;">
                    <div class="section-title"><i class="fa-solid fa-table-list"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                </div>

                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
                    </div>
                    <div class="table-scroll">
                        <table id="categoryStatsTable">
                            <thead>
                                <tr>
                                    <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Items)</th> <!-- New Column Header -->
                                    <th>HN ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</th>
                                    <th>HN ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                                    <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                    <th>‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡πâ‡∏≥</th>
                                </tr>
                            </thead>
                            <tbody id="categoryStatsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>üèÜ 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</h3>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</th></tr></thead>
                            <tbody id="performanceMatrixBody"></tbody>
                        </table>
                    </div>
                </div>

                 <div class="table-wrapper">
                    <div class="table-header">
                        <h3>üíé Top 20 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>HN</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead>
                            <tbody id="topSpendersBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div class="table-header">
                        <h3>üîÑ ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (Repeat Customers)</h3>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr><th>HN</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th><th>‡∏ß‡∏±‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr></thead>
                            <tbody id="repeatCustomersBody"></tbody>
                        </table>
                    </div>
                </div>

            </div> <!-- End Dashboard Content -->
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" style="font-size:1.3em;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
                <span class="close-btn" onclick="closeModal('customerModal')">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- AI Summary Modal -->
    <div id="aiSummaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-size:1.3em;"><i class="fa-brands fa-google"></i> ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI (Gemini)</h2>
                <span class="close-btn" onclick="closeModal('aiSummaryModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:10px; color:var(--text-muted);">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Gemini/ChatGPT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå</p>
                <textarea id="aiSummaryText" readonly></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="copyAIPrompt(this)">
                    <i class="fa-regular fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & DEFAULTS ---
        Chart.defaults.font.family = "'Prompt', sans-serif";
        Chart.defaults.color = '#6b7280';
        Chart.defaults.scale.grid.color = '#f3f4f6';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(17, 24, 39, 0.9)';
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        
        // --- 2. GLOBAL VARIABLES ---
        let rawData = [], filteredData = [], compareFilteredData = [];
        let charts = {}, currentModalCustomers = [], rfmSegmentData = {};
        
        // DOM Elements
        const els = {
            fileInput: document.getElementById('fileInput'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            filterBtn: document.getElementById('filterButton'),
            compareToggle: document.getElementById('compareToggle'),
            compareRange: document.getElementById('compareDateRange'),
            compareStart: document.getElementById('compareStartDate'),
            compareEnd: document.getElementById('compareEndDate'),
            aiBtn: document.getElementById('aiSummaryButton'),
            exportPdfBtn: document.getElementById('exportPdfButton'), // Add this
            initialState: document.getElementById('initialState'),
            dashboardContent: document.getElementById('dashboardContent')
        };

        // --- 3. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            setupEventListeners();
        });

        function setDefaultDates() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            els.endDate.value = `${year}-${month}-${day}`;
            els.startDate.value = `${year}-${month}-01`;
        }

        function setupEventListeners() {
            els.fileInput.addEventListener('change', handleFile);
            els.compareToggle.addEventListener('change', () => {
                els.compareRange.style.display = els.compareToggle.checked ? 'flex' : 'none';
                if (!els.compareToggle.checked) filterData(); // Re-filter if turned off
            });
            // Click outside modal
            window.onclick = (e) => {
                if (e.target.classList.contains('modal')) closeModal(e.target.id);
            };
        }

        // --- 4. DATA PROCESSING ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                processData(new Uint8Array(event.target.result));
            };
            reader.onerror = () => alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå");
            
            // Show loading UI
            els.initialState.innerHTML = `<div class="loading"><div class="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>`;
            reader.readAsArrayBuffer(file);
        }

        function processData(buffer) {
            try {
                const workbook = XLSX.read(buffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: null, raw: false });

                if (jsonData.length === 0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

                rawData = jsonData.map(row => {
                    if (!row) return null;
                    // Clean amount
                    let amt = 0;
                    if (row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']) {
                        if (typeof row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] === 'number') amt = row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                        else amt = parseFloat(row['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'].toString().replace(/[,\s]/g, '')) || 0;
                    }
                    // Clean phone
                    let phone = row['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || row['‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || row['Phone'] || row['Tel'] || '-';
                    
                    // Normalize Reg Date Key (Try common names)
                    let regDateStr = row['‡∏ß‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'] || row['Register Date'] || row['RegDate'] || null;

                    return { 
                        ...row, 
                        '‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞': amt, 
                        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': String(phone),
                        '__regDate': regDateStr ? parseThaiDate(regDateStr) : null // Pre-parse reg date
                    };
                }).filter(r => r !== null);

                // Auto-set Date Range from data
                let minDate = null, maxDate = null;
                rawData.forEach(row => {
                    const d = parseThaiDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                    if(d) {
                        if(!minDate || d < minDate) minDate = d;
                        if(!maxDate || d > maxDate) maxDate = d;
                    }
                });
                
                if(minDate && maxDate) {
                    els.startDate.value = formatDateToInput(minDate);
                    els.endDate.value = formatDateToInput(maxDate);
                }

                // Enable UI
                els.initialState.style.display = 'none';
                els.dashboardContent.style.display = 'block';
                [els.startDate, els.endDate, els.filterBtn, els.compareToggle, els.compareStart, els.compareEnd, els.aiBtn, els.exportPdfBtn].forEach(el => el.disabled = false);

                filterData();

            } catch (err) {
                console.error(err);
                els.initialState.innerHTML = `<div style="color:red"><i class="fa-solid fa-triangle-exclamation"></i><br>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</div>`;
            }
        }

        function filterData() {
            const start = parseInputDate(els.startDate.value);
            const end = parseInputDate(els.endDate.value, true); // End of day

            if (!start || !end) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

            filteredData = rawData.filter(row => {
                const d = parseThaiDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                return d && d >= start && d <= end;
            });

            compareFilteredData = [];
            if (els.compareToggle.checked) {
                const cStart = parseInputDate(els.compareStart.value);
                const cEnd = parseInputDate(els.compareEnd.value, true);
                if (cStart && cEnd) {
                    compareFilteredData = rawData.filter(row => {
                        const d = parseThaiDate(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                        return d && d >= cStart && d <= cEnd;
                    });
                }
            }

            updateDashboard();
        }

        // --- 5. LOGIC HELPERS ---
        function parseThaiDate(str) {
            if (!str || typeof str !== 'string') return null;
            try {
                const parts = str.trim().split(/[\/\-]/); // Split by / or -
                if (parts.length !== 3) return null;
                // Assuming DD/MM/YYYY
                let d = parseInt(parts[0]), m = parseInt(parts[1]) - 1, y = parseInt(parts[2]);
                if (y > 2500) y -= 543; // Convert Thai Year
                
                // Safety check for valid date
                const dateObj = new Date(y, m, d);
                if (dateObj.getFullYear() === y && dateObj.getMonth() === m && dateObj.getDate() === d) {
                    return dateObj;
                }
                return null;
            } catch (e) { return null; }
        }

        function parseInputDate(val, isEndOfDay = false) {
            if (!val) return null;
            const d = new Date(val);
            if (isEndOfDay) d.setHours(23, 59, 59, 999);
            else d.setHours(0,0,0,0);
            return d;
        }

        function formatDateToInput(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getCategoryForRow(row) {
            let name = (row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] || '').toString().toLowerCase().trim();
            if (!name) return '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';

            // --- 1. Specific / New Requests (High Priority) ---
            if (name.includes('sculptra')) return 'Sculptra';
            if (name.includes('exosome')) return 'Exosome';
            if (name.includes('rejuran')) return 'Rejuran';
            if (name.includes('juvelook')) return 'Juvelook'; // Added Juvelook
            if (name.includes('subsicion') || name.includes('subcision')) return 'Subsicion';
            
            // New Categories requested
            if (name.includes('helios')) return 'Helios';
            if (name.includes('vella')) return 'Vella';
            if (name.includes('viva')) return 'Viva';
            if (name.includes('virgin repair')) return 'Virgin Repair';
            if (name.includes('body s')) return 'Body S';
            if (name.includes('g5')) return 'G5';
            if (name.includes('transamin')) return 'Transamin';
            
            // RF (Be careful with matches, but usually safe in this context)
            if (name.includes('rf')) return 'RF';

            // --- 2. Meso Grouping ---
            if (name.includes('chanel') || name.includes('l\'ebssc') || name.includes('inno') || name.includes('sakura') || name.includes('meso') || name.includes('made') || name.includes('‡∏â‡∏µ‡∏î‡∏´‡∏ô‡πâ‡∏≤') || name.includes('prp')) return 'Meso';

            // --- 3. Drip Grouping (Updated) ---
            // Added: detox, diamond, celeb extra
            if (name.includes('drip') || name.includes('diamond') || name.includes('celeb') || name.includes('detox') || name.includes('vitamin') || name.includes('‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô')) return 'Drip';

            // --- 4. Existing Categories ---
            if ((name.includes('‡∏®‡∏±‡∏•‡∏¢‡∏Å‡∏£‡∏£‡∏°') || name.includes('‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏°‡∏π‡∏Å') || name.includes('‡∏ï‡∏≤') || name.includes('‡∏Ñ‡∏≤‡∏á')) && !name.includes('‡πÇ‡∏ó‡∏£‡∏ï‡∏≤‡∏°') && !name.includes('botox')) return 'Surgery';
            if (name.includes('ultraformer') || name.includes('ultra fromer')) return 'Ultraformer';
            if (name.includes('co2')) return 'Co2';
            
            // Slimnow: Removed 'g5' and 'rf' as they have their own categories now
            if (name.includes('slimnow') || name.includes('peptide') || name.includes('‡∏Ñ‡∏∏‡∏°‡∏´‡∏¥‡∏ß')) return 'Slimnow';
            
            if (name.includes('dio')) return 'Diode laser';
            if (name.includes('botox') || name.includes('‡πÇ‡∏ö')) return 'Botox';
            if (name.includes('filler') || name.includes('‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏≠‡∏£‡πå')) return 'Filler';
            if (name.includes('hifu') || name.includes('ulthera') || name.includes('lifting')) return 'HIFU / Lifting';
            
            // Picolaser (Was Laser Skin)
            if (name.includes('laser') || name.includes('ipl') || name.includes('pico') || name.includes('‡πÄ‡∏•‡πÄ‡∏ã‡∏≠‡∏£‡πå')) return 'Picolaser';
            
            if (name.includes('hair') || name.includes('‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏Ç‡∏ô')) return 'Hair Removal';
            if (name.includes('fat') || name.includes('‡∏™‡∏•‡∏≤‡∏¢‡πÑ‡∏Ç‡∏°‡∏±‡∏ô')) return 'Body / Fat';
            if (name.includes('acne') || name.includes('‡∏™‡∏¥‡∏ß')) return 'Acne Treatment';
            if (name.includes('‡∏¢‡∏≤') || name.includes('medicine') || name.includes('drug') || name.includes('pharmacy') || name.includes('‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå')) return 'Pharmacy / Medicine';
            if (name.includes('treatment') || name.includes('‡∏ó‡∏£‡∏µ‡∏ó‡πÄ‡∏°‡∏ô‡∏ó‡πå') || name.includes('‡∏ô‡∏ß‡∏î') || name.includes('spa')) return 'Treatment';
            if (name.includes('‡∏Ñ‡πà‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå') || name.includes('df') || name.includes('doctor') || name.includes('consult') || name.includes('‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£') || name.includes('service')) return 'Consultation / Service';
            if (name.includes('product') || name.includes('cream') || name.includes('gel') || name.includes('foam') || name.includes('sunscreen') || name.includes('set')) return 'Products / Skincare';
            
            return 'General / Others';
        }

        // --- 6. UPDATE DASHBOARD UI ---
        function updateDashboard() {
            updateStats();
            updateCharts();
            
            // RFM Calculation
            rfmSegmentData = calculateRFMSegments();
            updateRecencyFrequencyPlot(rfmSegmentData);
            updateRFMInsights(rfmSegmentData);
            
            // Tables
            updateCategoryStatsTable();
            updatePerformanceMatrix();
            updateRepeatCustomersTable();
            updateTopSpendersTable();
            // Removed Transaction History Table Update
        }

        // --- 7. STATS & COMPARISON ---
        function updateStats() {
            const start = parseInputDate(els.startDate.value);
            const end = parseInputDate(els.endDate.value, true);

            const calc = (data, isCompare = false) => {
                if (!data.length) return { rev: 0, visit: 0, cust: 0, payCust: 0, repeat: 0, rate: 0, newReg: 0 };
                const uniqueHN = new Set(data.map(r => r.HN).filter(x => x));
                const payHN = new Set(data.filter(r => r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] > 0).map(r => r.HN));
                const rev = data.reduce((s, r) => s + (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] || 0), 0);
                
                // Visits
                const visits = data.reduce((acc, r) => {
                    if (r.HN && r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) {
                        if (!acc[r.HN]) acc[r.HN] = new Set();
                        acc[r.HN].add(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                    }
                    return acc;
                }, {});
                const totalVisits = Object.values(visits).reduce((s, v) => s + v.size, 0);
                const repeatCount = Object.values(visits).filter(v => v.size > 1).length;
                const rate = uniqueHN.size ? (repeatCount / uniqueHN.size) * 100 : 0;
                
                // NEW: Calculate New Customers based on Registration Date
                // We must look at Unique HNs in the current filtered set, and check their reg date
                let newRegCount = 0;
                
                // Note: uniqueHN contains HNs present in filtered sales data.
                // We need to check if these HNs have a reg date within range.
                // Since data is flattened, we find the first row with this HN to check reg date.
                const checkedHN = new Set();
                data.forEach(r => {
                    if(r.HN && !checkedHN.has(r.HN)) {
                        checkedHN.add(r.HN);
                        if(r.__regDate) {
                            // Check if reg date is within the current filter range
                            // Use start/end from global state if not compare, or passed range if compare
                            let rangeStart = start;
                            let rangeEnd = end;
                            
                            if (isCompare) {
                                rangeStart = parseInputDate(els.compareStart.value);
                                rangeEnd = parseInputDate(els.compareEnd.value, true);
                            }

                            if (rangeStart && rangeEnd && r.__regDate >= rangeStart && r.__regDate <= rangeEnd) {
                                newRegCount++;
                            }
                        }
                    }
                });

                return { rev, visit: totalVisits, cust: uniqueHN.size, payCust: payHN.size, repeat: repeatCount, rate, newReg: newRegCount };
            };

            const cur = calc(filteredData, false);
            const prev = els.compareToggle.checked ? calc(compareFilteredData, true) : null;

            updateStatCard('totalRevenue', cur.rev, prev?.rev, true);
            updateStatCard('totalVisits', cur.visit, prev?.visit);
            updateStatCard('totalCustomers', cur.cust, prev?.cust);
            updateStatCard('newCustomers', cur.newReg, prev?.newReg); // New Card Update
            updateStatCard('payingCustomers', cur.payCust, prev?.payCust); // Kept in logic but hidden in HTML if not used
            updateStatCard('repeatRate', cur.rate, prev?.rate, false, true);
        }

        function updateStatCard(id, val, prevVal, isMoney = false, isPct = false) {
            const el = document.getElementById(id);
            if(!el) return;

            let txt = val.toLocaleString(undefined, { minimumFractionDigits: isMoney ? 2 : (isPct ? 1 : 0) });
            if (isPct) txt += '%';
            
            let badgeHtml = '';
            if (prevVal !== undefined && prevVal !== null) {
                const diff = val - prevVal;
                const pct = prevVal === 0 ? (val > 0 ? 100 : 0) : (diff / prevVal) * 100;
                const cls = diff > 0 ? 'pos' : (diff < 0 ? 'neg' : 'neu');
                const icon = diff > 0 ? 'up' : (diff < 0 ? 'down' : 'minus');
                
                let diffText = '';
                if (!isPct) {
                    let unit = '';
                    if (isMoney) unit = ' ‡∏ö.';
                    else if (id.toLowerCase().includes('visit')) unit = ' ‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    else unit = ' ‡∏Ñ‡∏ô'; // Customers
                    
                    // Format diff value (no decimals for counts, maybe 0 decimals for large money diffs in badge to save space)
                    const diffVal = diff.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    diffText = ` <span style="opacity:0.9; margin-left:3px;">(${diff > 0 ? '+' : ''}${diffVal}${unit})</span>`;
                }

                badgeHtml = `<span class="badge ${cls}"><i class="fa-solid fa-caret-${icon}"></i> ${Math.abs(pct).toFixed(1)}%${diffText}</span>`;
            }
            el.innerHTML = `${txt} ${badgeHtml}`;
        }

        // --- 8. CHARTS ---
        function updateCharts() {
            // Destroy old charts
            Object.values(charts).forEach(c => c.destroy());
            charts = {};

            // 1. Daily Sales
            const daily = filteredData.reduce((acc, r) => {
                if(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) acc[r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']] = (acc[r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']]||0) + (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0);
                return acc;
            }, {});
            const sortedDates = Object.keys(daily).sort((a,b) => parseThaiDate(a) - parseThaiDate(b));
            
            charts.daily = new Chart(document.getElementById('dailySalesChart'), {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        data: sortedDates.map(d => daily[d]),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false} } } }
            });

            // 2. Category Pie
            const cats = filteredData.reduce((acc, r) => {
                if(r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] > 0) {
                    const c = getCategoryForRow(r);
                    acc[c] = (acc[c]||0) + r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                }
                return acc;
            }, {});
            const sortedCats = Object.entries(cats).sort((a,b) => b[1] - a[1]).slice(0, 8);
            
            charts.cat = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedCats.map(x => x[0]),
                    datasets: [{
                        data: sortedCats.map(x => x[1]),
                        backgroundColor: ['#6366f1', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    cutout: '65%',
                    plugins: { legend: { position: 'right' } }
                }
            });

            // 3. Monthly Bar
            const monthly = filteredData.reduce((acc, r) => {
                const d = parseThaiDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                if(d) {
                    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    acc[k] = (acc[k]||0) + (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0);
                }
                return acc;
            }, {});
            const sortedM = Object.keys(monthly).sort();
            
            charts.monthly = new Chart(document.getElementById('monthlySalesChart'), {
                type: 'bar',
                data: {
                    labels: sortedM.map(k => {
                        const [y, m] = k.split('-');
                        return new Date(y, m-1).toLocaleDateString('th-TH', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        data: sortedM.map(k => monthly[k]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: {display:false} } } }
            });
            
             // 5. Frequency Distribution
             const hnVisits = filteredData.reduce((acc, row) => {
                if(row.HN && row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) {
                    if(!acc[row.HN]) acc[row.HN] = new Set();
                    acc[row.HN].add(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                }
                return acc;
             }, {});
             
             // Count distribution and store HNs
             const freqMap = {}; // Key: Count, Value: Array of HNs
             Object.entries(hnVisits).forEach(([hn, dates]) => {
                 const count = dates.size;
                 if(!freqMap[count]) freqMap[count] = [];
                 freqMap[count].push(hn);
             });

             const freqLabels = Object.keys(freqMap).map(Number).sort((a,b)=>a-b);
             
             charts.freq = new Chart(document.getElementById('frequencyDistributionChart'), {
                 type: 'bar',
                 data: {
                     labels: freqLabels.map(f => `${f} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`),
                     datasets: [{
                         label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏ô)',
                         data: freqLabels.map(f => freqMap[f].length),
                         backgroundColor: '#8b5cf6',
                         borderRadius: 4
                     }]
                 },
                 options: { 
                     responsive: true, 
                     maintainAspectRatio: false, 
                     scales: { x: { grid: {display:false} } },
                     onClick: (e, active) => {
                        if(active.length > 0) {
                            const index = active[0].index;
                            const freqCount = freqLabels[index];
                            const hnList = freqMap[freqCount];
                            // Pass false to hide copy section
                            renderCustomerListModal(`‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ${freqCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`, hnList, null, false);
                        }
                     },
                     plugins: {
                         tooltip: {
                             callbacks: {
                                 footer: () => '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'
                             }
                         }
                     }
                 }
             });
        }
        
        // --- 9. RFM & SCATTER PLOTS ---
        function calculateRFMSegments() {
            const paying = filteredData.filter(r => r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] > 0);
            if (!paying.length) return { loyal: [], atRisk: [], newCust: [], lost: [] };
            
            const endDate = parseInputDate(els.endDate.value, true);
            
            const hnStats = paying.reduce((acc, r) => {
                const hn = r.HN;
                const d = parseThaiDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                if (hn && d) {
                    if (!acc[hn]) acc[hn] = { dates: new Set() };
                    acc[hn].dates.add(d.toISOString().split('T')[0]);
                }
                return acc;
            }, {});

            const customers = Object.keys(hnStats).map(hn => {
                const dates = [...hnStats[hn].dates].map(d => new Date(d)).sort((a, b) => b - a);
                const recency = Math.floor((endDate - dates[0]) / (1000 * 60 * 60 * 24));
                const frequency = dates.length;
                return { hn, recency, frequency };
            });

            // Simplify Logic: Just quartiles or simple threshold
            const segments = { loyal: [], atRisk: [], newCust: [], lost: [] };
            customers.forEach(c => {
                const p = { x: c.recency, y: c.frequency, hn: c.hn };
                if (c.frequency >= 3 && c.recency <= 60) segments.loyal.push(p);
                else if (c.frequency >= 3 && c.recency > 60) segments.atRisk.push(p);
                else if (c.frequency < 3 && c.recency <= 30) segments.newCust.push(p);
                else segments.lost.push(p);
            });
            return segments;
        }

        function updateRecencyFrequencyPlot(segments) {
            const ctx = document.getElementById('recencyFrequencyPlot');
            charts.rfm = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'Loyal', data: segments.loyal, backgroundColor: '#10b981' },
                        { label: 'At Risk', data: segments.atRisk, backgroundColor: '#f59e0b' },
                        { label: 'New', data: segments.newCust, backgroundColor: '#3b82f6' },
                        { label: 'Lost', data: segments.lost, backgroundColor: '#9ca3af' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, active) => {
                        if(active.length) {
                             const p = charts.rfm.data.datasets[active[0].datasetIndex].data[active[0].index];
                             showCustomerDetail(p.hn);
                        }
                    },
                    scales: {
                        x: { title: {display:true, text:'‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô)'} },
                        y: { title: {display:true, text:'‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'} }
                    },
                    plugins: { tooltip: { callbacks: { label: c => `HN: ${c.raw.hn}` } } }
                }
            });
        }
        
        function updatePerformanceMatrix() {
             const ctx = document.getElementById('performanceMatrixChart');
             const items = filteredData.reduce((acc, r) => {
                 if(r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] > 0 && r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']) {
                     const n = r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'];
                     if(!acc[n]) acc[n] = { rev:0, qty:0, customers: new Set() }; // Changed to track customers
                     acc[n].rev += r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                     acc[n].qty++;
                     if(r.HN) acc[n].customers.add(r.HN); // Track HN
                 }
                 return acc;
             }, {});
             
             const data = Object.entries(items).sort((a,b)=>b[1].rev - a[1].rev).slice(0, 10).map(([k,v]) => ({
                 label: k, x: v.qty, y: v.rev/v.qty
             }));
             
             charts.perf = new Chart(ctx, {
                 type: 'scatter',
                 data: {
                     datasets: [{ 
                         label: 'Top Items', data, backgroundColor: '#ec4899', pointRadius: 8 
                     }]
                 },
                 options: {
                     responsive: true, maintainAspectRatio: false,
                     plugins: { tooltip: { callbacks: { label: c => `${c.raw.label}: ${c.raw.y.toLocaleString()} ‡∏ö. (${c.raw.x} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)` } } },
                     scales: {
                         x: { title: {display:true, text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏¢ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)'} },
                         y: { title: {display:true, text:'‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó)'} }
                     }
                 }
             });
             
             // Update Table too
             const tbody = document.getElementById('performanceMatrixBody');
             // Top 20 for table
             const tableData = Object.entries(items).sort((a,b)=>b[1].rev - a[1].rev).slice(0, 20);
             if(!tableData.length) tbody.innerHTML = `<tr><td colspan="6" style="text-align:center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
             else {
                 tbody.innerHTML = tableData.map(([k,v], i) => `
                    <tr>
                        <td style="text-align:center">${i+1}</td>
                        <td>${k}</td>
                        <td style="text-align:right">${v.rev.toLocaleString()}</td>
                        <td style="text-align:center">${v.qty.toLocaleString()}</td>
                        <td style="text-align:right">${(v.rev/v.qty).toLocaleString(undefined,{maximumFractionDigits:0})}</td>
                        <td style="text-align:center">${v.customers.size.toLocaleString()}</td>
                    </tr>
                 `).join('');
             }
        }

        function updateRFMInsights(segments) {
            const container = document.getElementById('rfmInsightsContainer');
            const total = segments.loyal.length + segments.atRisk.length + segments.newCust.length + segments.lost.length;
            if(!total) { container.innerHTML = ''; return; }
            
            const groups = [
                 { key: 'loyal', name: 'Loyal Customers', count: segments.loyal.length, color: '#10b981', desc: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏î‡∏µ ‡∏°‡∏≤‡∏ö‡πà‡∏≠‡∏¢ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏Å', action: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ê‡∏≤‡∏ô ‡πÉ‡∏´‡πâ VIP Reward' },
                 { key: 'atRisk', name: 'At Risk', count: segments.atRisk.length, color: '#f59e0b', desc: '‡πÄ‡∏Ñ‡∏¢‡∏°‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ', action: '‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°, ‡∏™‡πà‡∏á‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô' },
                 { key: 'newCust', name: 'New Potential', count: segments.newCust.length, color: '#3b82f6', desc: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏±‡∏í‡∏ô‡∏≤', action: '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á' },
                 { key: 'lost', name: 'Lost', count: segments.lost.length, color: '#9ca3af', desc: '‡∏ô‡∏≤‡∏ô‡πÜ ‡∏°‡∏≤‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ô‡∏≤‡∏ô', action: '‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏£‡∏á‡πÜ' }
            ];
            
            container.innerHTML = `
                <div class="insights-box">
                    <h4 style="margin-bottom:10px;"><i class="fa-solid fa-lightbulb"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h4>
                    <p>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <strong>${groups.sort((a,b)=>b.count-a.count)[0].name}</strong> ‡∏Ñ‡∏ß‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</p>
                </div>
                <div class="stats-grid">
                    ${groups.map(g => `
                        <div class="stat-card" style="border-left: 4px solid ${g.color}; cursor:pointer;" onclick="showSegmentDetails('${g.key}', '${g.name}')">
                            <div class="stat-value" style="color:${g.color}">${g.count} <span style="font-size:0.5em; color:#999">(${(g.count/total*100).toFixed(0)}%)</span></div>
                            <div class="stat-label" style="font-weight:bold">${g.name}</div>
                            <div style="font-size:0.85em; margin-top:5px; color:#666">${g.action}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- 10. TABLES ---
        function updateCategoryStatsTable() {
            const tbody = document.getElementById('categoryStatsBody');
            const thead = document.querySelector('#categoryStatsTable thead tr');
            
            const isCompare = els.compareToggle.checked;

            // Helper to process data
            const process = (dataset) => dataset.reduce((acc, r) => {
                const c = getCategoryForRow(r);
                if(!acc[c]) acc[c] = { rev:0, hn:new Set(), payHn:new Set(), visits:{}, items: new Set() };
                acc[c].rev += (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0);
                if(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']) acc[c].items.add(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']);
                if(r.HN) {
                    acc[c].hn.add(r.HN);
                    if(r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']>0) acc[c].payHn.add(r.HN);
                    if(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) (acc[c].visits[r.HN] = acc[c].visits[r.HN]||new Set()).add(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                }
                return acc;
            }, {});

            const curData = process(filteredData);
            const prevData = isCompare ? process(compareFilteredData) : {};

            // Get all unique categories
            const allCats = new Set([...Object.keys(curData), ...Object.keys(prevData)]);
            const sortedCats = [...allCats].sort((a,b) => (curData[b]?.rev||0) - (curData[a]?.rev||0));

            // Update Header
            if(isCompare) {
                thead.innerHTML = `
                    <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                    <th style="text-align:right">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</th>
                    <th style="text-align:right">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)</th>
                    <th style="text-align:center">% ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                    <th style="text-align:center">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</th>
                    <th style="text-align:center">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤)</th>
                    <th style="text-align:center">% ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                `;
            } else {
                thead.innerHTML = `
                    <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Items)</th>
                    <th>HN ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</th>
                    <th>HN ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                    <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                    <th>‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡πâ‡∏≥</th>
                `;
            }

            tbody.innerHTML = sortedCats.map(k => {
                const cur = curData[k] || { rev:0, hn:new Set(), payHn:new Set(), visits:{}, items: new Set() };
                
                // Items string
                const itemsArr = Array.from(cur.items);
                const itemsStr = itemsArr.slice(0, 5).join(', ') + (itemsArr.length > 5 ? ` ... (+${itemsArr.length - 5})` : '');

                if(isCompare) {
                    const prev = prevData[k] || { rev:0, payHn: new Set() };
                    
                    // Sales Diff
                    const diffRev = cur.rev - prev.rev;
                    const pctRev = prev.rev === 0 ? (cur.rev > 0 ? 100 : 0) : (diffRev / prev.rev) * 100;
                    const iconRev = diffRev > 0 ? 'fa-arrow-up' : (diffRev < 0 ? 'fa-arrow-down' : 'fa-minus');
                    const badgeRevClass = diffRev > 0 ? 'pos' : (diffRev < 0 ? 'neg' : 'neu');

                    // HN Diff
                    const curHN = cur.payHn.size;
                    const prevHN = prev.payHn ? prev.payHn.size : 0;
                    const diffHN = curHN - prevHN;
                    const pctHN = prevHN === 0 ? (curHN > 0 ? 100 : 0) : (diffHN / prevHN) * 100;
                    const iconHN = diffHN > 0 ? 'fa-arrow-up' : (diffHN < 0 ? 'fa-arrow-down' : 'fa-minus');
                    const badgeHNClass = diffHN > 0 ? 'pos' : (diffHN < 0 ? 'neg' : 'neu');

                    return `<tr>
                        <td><span class="clickable" onclick="showCustomersForCategory('${k}')">${k}</span></td>
                        <td style="text-align:right; font-weight:bold;">${cur.rev.toLocaleString()}</td>
                        <td style="text-align:right; color:#666;">${prev.rev.toLocaleString()}</td>
                        <td style="text-align:center">
                            <span class="badge ${badgeRevClass}">
                                <i class="fa-solid ${iconRev}"></i> ${Math.abs(pctRev).toFixed(1)}%
                            </span>
                        </td>
                        <td style="text-align:center; font-weight:bold;">${curHN.toLocaleString()}</td>
                        <td style="text-align:center; color:#666;">${prevHN.toLocaleString()}</td>
                        <td style="text-align:center">
                            <span class="badge ${badgeHNClass}">
                                <i class="fa-solid ${iconHN}"></i> ${Math.abs(pctHN).toFixed(1)}%
                            </span>
                        </td>
                    </tr>`;
                } else {
                    const repeat = Object.values(cur.visits).filter(x => x.size > 1).length;
                    return `<tr>
                        <td><span class="clickable" onclick="showCustomersForCategory('${k}')">${k}</span></td>
                        <td style="font-size:0.85em; color:#666; max-width:300px;">${itemsStr}</td>
                        <td style="text-align:center">${cur.hn.size}</td>
                        <td style="text-align:center">${cur.payHn.size}</td>
                        <td style="text-align:right">${cur.rev.toLocaleString()}</td>
                        <td style="text-align:center">${repeat}</td>
                    </tr>`;
                }
            }).join('');
        }
        
        function updateRepeatCustomersTable() {
            const tbody = document.getElementById('repeatCustomersBody');
            const hnData = filteredData.reduce((acc, r) => {
                if(!r.HN) return acc;
                if(!acc[r.HN]) acc[r.HN] = { name:r['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'], phone:r['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'], rev:0, dates:new Set() };
                acc[r.HN].rev += (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0);
                if(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) acc[r.HN].dates.add(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                return acc;
            }, {});
            
            const list = Object.entries(hnData)
                .filter(([k,v]) => v.dates.size > 1)
                .map(([k,v]) => {
                    const sortedD = [...v.dates].sort((a,b)=>parseThaiDate(b)-parseThaiDate(a));
                    return { hn:k, ...v, count: v.dates.size, last: sortedD[0] };
                })
                .sort((a,b) => b.rev - a.rev)
                .slice(0, 100);
            
            tbody.innerHTML = list.map(c => `
                <tr>
                    <td><span class="clickable" onclick="showCustomerDetail('${c.hn}')">${c.hn}</span></td>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td style="text-align:center">${c.count}</td>
                    <td style="text-align:center">${c.dates.size}</td>
                    <td style="text-align:right">${c.rev.toLocaleString()}</td>
                    <td>${c.last}</td>
                </tr>
            `).join('');
        }
        
        function updateTopSpendersTable() {
            const tbody = document.getElementById('topSpendersBody');
            const hnData = filteredData.reduce((acc, r) => {
                if(!r.HN || (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0)<=0) return acc;
                if(!acc[r.HN]) acc[r.HN] = { name:r['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'], phone:r['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'], rev:0, items:new Set() };
                acc[r.HN].rev += r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                if(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']) acc[r.HN].items.add(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']);
                return acc;
            }, {});
            
            const list = Object.entries(hnData)
                .map(([k,v]) => ({hn:k, ...v}))
                .sort((a,b)=>b.rev - a.rev)
                .slice(0, 20);
                
            tbody.innerHTML = list.map((c,i) => `
                <tr>
                    <td style="text-align:center"><span style="font-weight:bold; color:${i<3?'#d97706':'#666'}">${i+1}</span></td>
                    <td>${c.hn}</td>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td style="font-size:0.85em; color:#666; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${[...c.items].join(', ')}</td>
                    <td style="text-align:right; font-weight:bold; color:#ec4899">${c.rev.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // --- 11. MODALS & AI ---
        function openModal(id) {
            const m = document.getElementById(id);
            m.style.display = 'block';
            setTimeout(() => m.classList.add('show'), 10);
        }
        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 300);
        }
        
        function showCustomerDetail(hn) {
            const trans = filteredData.filter(r => r.HN === hn);
            if(!trans.length) return;
            const info = trans[0];
            const total = trans.reduce((s,r)=>s+(r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0),0);
            
            document.getElementById('modalTitle').textContent = `üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${info['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•']}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-bottom:15px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><strong>HN:</strong> ${hn}</div>
                    <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${info['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£']}</div>
                    <div><strong>‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°:</strong> <span style="color:#10b981; font-weight:bold">${total.toLocaleString()} ‡∏ø</span></div>
                    <div><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ${new Set(trans.map(r=>r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'])).size}</div>
                    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> ${info.__regDate ? info.__regDate.toLocaleDateString('th-TH') : '-'}</div>
                </div>
                <h4>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h4>
                <div style="max-height:300px; overflow-y:auto; margin-top:10px;">
                    <table>
                        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th></tr></thead>
                        <tbody>
                            ${trans.sort((a,b)=>(parseThaiDate(b['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'])||0)-(parseThaiDate(a['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'])||0)).map(r=>`
                                <tr>
                                    <td>${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']}</td>
                                    <td>${r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']}</td>
                                    <td style="text-align:right">${(r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            openModal('customerModal');
        }
        
        function showCustomersForCategory(cat) {
            const hns = new Set();
            filteredData.forEach(r => { if(getCategoryForRow(r)===cat && r.HN) hns.add(r.HN); });
            // Modified to pass the category filter
            renderCustomerListModal(`‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${cat}`, [...hns], cat, false);
        }
        
        function showSegmentDetails(key, name) {
            if(!rfmSegmentData[key]) return;
            renderCustomerListModal(`‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${name}`, rfmSegmentData[key].map(x=>x.hn), null, false);
        }
        
        // Modified function to accept showCopy parameter (default false)
        function renderCustomerListModal(title, hnList, filterCat = null, showCopy = false) {
            document.getElementById('modalTitle').textContent = `üìÇ ${title} (${hnList.length} ‡∏Ñ‡∏ô)`;
            
            // Aggregate data for list (Calculate ALL data first)
            const fullList = hnList.map(hn => {
                let rows = filteredData.filter(r => r.HN === hn);
                
                // If filtering by category (for "Sales by Category" popup)
                if(filterCat) {
                    rows = rows.filter(r => getCategoryForRow(r) === filterCat);
                }

                if (rows.length === 0) return null;

                const rev = rows.reduce((s,r) => s + (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞']||0), 0);
                
                // Find latest visit date
                const dates = rows.map(r => parseThaiDate(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢'])).filter(d => d);
                const lastVisit = dates.length ? new Date(Math.max.apply(null, dates)) : null;
                const lastVisitStr = lastVisit ? lastVisit.toLocaleDateString('th-TH') : '-';

                // Extract items
                const itemsSet = new Set();
                rows.forEach(r => { if(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']) itemsSet.add(r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']); });
                const itemsStr = Array.from(itemsSet).join(', ');

                return { hn, name: rows[0]['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'], phone: rows[0]['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'], rev, items: itemsStr, lastVisit: lastVisitStr };
            }).filter(item => item !== null)
              .sort((a,b) => b.rev - a.rev);
            
            // 2. Slice for Display (Limit to top 200 for UI performance)
            const displayList = fullList.slice(0, 200);

            // Removing Copy Section Logic
            let copySectionHtml = '';
            /*
            if (showCopy) {
                // ... (Removed) ...
            }
            */

            document.getElementById('modalBody').innerHTML = `
                <div style="max-height:600px; overflow-y:auto;">
                    <table>
                        <thead><tr><th>HN</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏¢‡∏≠‡∏î (‡∏ö‡∏≤‡∏ó)</th><th>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th></tr></thead>
                        <tbody>
                            ${displayList.map(c => `
                                <tr>
                                    <td><span class="clickable" onclick="showCustomerDetail('${c.hn}')">${c.hn}</span></td>
                                    <td>${c.name}<br><small style="color:#999">${c.phone}</small></td>
                                    <td style="font-size:0.9em; color:#555;">${c.items}</td>
                                    <td style="text-align:right; font-weight:bold;">${c.rev.toLocaleString()}</td>
                                    <td style="font-size:0.9em;">${c.lastVisit}</td>
                                </tr>
                            `).join('')}
                            ${fullList.length > 200 ? `<tr><td colspan="5" style="text-align:center; color:#888; font-style:italic;">...‡πÅ‡∏™‡∏î‡∏á 200 ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏£‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${fullList.length} ‡∏Ñ‡∏ô...</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
                ${copySectionHtml}
            `;
            openModal('customerModal');
        }

        function exportFrequencyData() {
            // 1. Calculate
            const hnVisits = filteredData.reduce((acc, row) => {
               if(row.HN && row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) {
                   if(!acc[row.HN]) acc[row.HN] = new Set();
                   acc[row.HN].add(row['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
               }
               return acc;
            }, {});
            
            const freqDist = {};
            Object.values(hnVisits).forEach(dates => {
                const count = dates.size;
                freqDist[count] = (freqDist[count] || 0) + 1;
            });

            // 2. Format HTML Table
            const keys = Object.keys(freqDist).map(Number).sort((a,b)=>a-b);
            let html = `<div style="max-height:500px; overflow-y:auto;"><table style="margin-top:10px;">
                        <thead>
                            <tr>
                                <th style="background:#eef2ff; color:#6366f1;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
                                <th style="background:#eef2ff; color:#6366f1; text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏ô)</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            keys.forEach(k => {
                html += `<tr>
                            <td style="font-weight:bold;">${k} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</td>
                            <td style="text-align:center;">${freqDist[k].toLocaleString()}</td>
                         </tr>`;
            });
            html += `</tbody></table></div>`;

            // 3. Render Modal
            document.getElementById('modalTitle').textContent = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£`;
            document.getElementById('modalBody').innerHTML = html;
            openModal('customerModal');
        }
        
        function exportToPDF() {
            const element = document.querySelector('.dashboard-container');
            const controls = document.querySelector('.controls-container');
            
            // 1. Hide controls
            controls.style.display = 'none';

            // 2. Get exact size
            const w = element.scrollWidth;
            const h = element.scrollHeight;

            // 3. Config for Single Page Screenshot
            const opt = {
                margin: 0,
                filename: `Clinic_Snapshot_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, // Retains quality
                    useCORS: true,
                    scrollY: 0,
                    windowWidth: w,
                    windowHeight: h
                },
                jsPDF: { 
                    unit: 'px', 
                    format: [w, h], 
                    orientation: w > h ? 'l' : 'p' 
                }
            };

            // Loading state
            const btn = document.getElementById('exportPdfButton');
            const oldContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            // 4. Generate
            html2pdf().set(opt).from(element).save().then(() => {
                controls.style.display = 'flex';
                btn.innerHTML = oldContent;
            }).catch(err => {
                console.error(err);
                alert('Export failed');
                controls.style.display = 'flex';
                btn.innerHTML = oldContent;
            });
        }

        function copyModalText(btn) {
            const t = document.getElementById('modalCopyText');
            t.select();
            navigator.clipboard.writeText(t.value);
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            setTimeout(() => btn.innerHTML = oldText, 2000);
        }

        function generateAISummary() {
            // Helper to get stats object
            const getStats = (data) => {
                if (!data || data.length === 0) return null;
                
                const payingRows = data.filter(r => (r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'] || 0) > 0);
                const totalRev = payingRows.reduce((s, r) => s + r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'], 0);
                
                const uniqueHN = new Set(data.map(r => r.HN).filter(x => x));
                const visits = data.reduce((acc, r) => {
                    if (r.HN && r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) acc.add(`${r.HN}|${r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']}`);
                    return acc;
                }, new Set());
                
                // Categories
                const cats = payingRows.reduce((acc, r) => {
                    const c = getCategoryForRow(r);
                    acc[c] = (acc[c] || 0) + r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                    return acc;
                }, {});
                const topCats = Object.entries(cats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([k, v]) => `${k} (${v.toLocaleString()} ‡∏ö.)`);

                // Items
                const items = payingRows.reduce((acc, r) => {
                    const n = r['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] || 'Unknown';
                    acc[n] = (acc[n] || 0) + r['‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞'];
                    return acc;
                }, {});
                const topItems = Object.entries(items)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([k, v]) => `${k} (${v.toLocaleString()} ‡∏ö.)`);

                // Repeat Rate
                const hnVisits = data.reduce((acc, r) => {
                    if (r.HN && r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']) {
                        if (!acc[r.HN]) acc[r.HN] = new Set();
                        acc[r.HN].add(r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢']);
                    }
                    return acc;
                }, {});
                const repeatCount = Object.values(hnVisits).filter(v => v.size > 1).length;
                const repeatRate = uniqueHN.size ? ((repeatCount / uniqueHN.size) * 100).toFixed(1) : 0;

                return {
                    rev: totalRev,
                    cust: uniqueHN.size,
                    visit: visits.size,
                    avgTicket: visits.size ? (totalRev / visits.size).toFixed(0) : 0,
                    topCats,
                    topItems,
                    repeatRate
                };
            };

            const cur = getStats(filteredData);
            const prev = els.compareToggle.checked ? getStats(compareFilteredData) : null;

            if (!cur) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•');

            let txt = `Role: ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°\n`;
            txt += `Task: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå\n\n`;
            
            txt += `## 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (${els.startDate.value} ‡∏ñ‡∏∂‡∏á ${els.endDate.value})\n`;
            txt += `- ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ${cur.rev.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${cur.cust.toLocaleString()} ‡∏Ñ‡∏ô\n`;
            txt += `- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Visits): ${cur.visit.toLocaleString()} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
            txt += `- ‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≠‡∏ö‡∏¥‡∏•‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Avg Ticket): ${cur.avgTicket.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
            txt += `- ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥ (Repeat Rate): ${cur.repeatRate}%\n`;
            txt += `- 5 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${cur.topCats.join(', ')}\n`;
            txt += `- 5 ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï: ${cur.topItems.join(', ')}\n`;

            if (prev) {
                const growth = (val, pVal) => {
                    if (!pVal) return 'N/A';
                    const pct = ((val - pVal) / pVal) * 100;
                    return `${pct > 0 ? '+' : ''}${pct.toFixed(1)}%`;
                };
                
                txt += `\n## 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (${els.compareStart.value} ‡∏ñ‡∏∂‡∏á ${els.compareEnd.value})\n`;
                txt += `- ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ${growth(cur.rev, prev.rev)}\n`;
                txt += `- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${growth(cur.cust, prev.cust)}\n`;
            }

            txt += `\n## 3. ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:\n`;
            txt += `1. [‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à] ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢, Avg Ticket ‡πÅ‡∏•‡∏∞ Repeat Rate ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?\n`;
            txt += `2. [‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£] ‡∏à‡∏≤‡∏Å Top Categories ‡πÅ‡∏•‡∏∞ Items ‡∏Ñ‡∏ß‡∏£‡∏à‡∏±‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠ Cross-sell ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?\n`;
            txt += `3. [‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢] ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° 'At Risk' (‡πÄ‡∏Ñ‡∏¢‡∏°‡∏≤‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£\n`;
            txt += `4. [Action Plan] ‡∏Ç‡∏≠ 3 ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤`;

            document.getElementById('aiSummaryText').value = txt;
            openModal('aiSummaryModal');
        }
        
        function copyAIPrompt(btn) {
            const t = document.getElementById('aiSummaryText');
            t.select();
            navigator.clipboard.writeText(t.value);
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            setTimeout(() => btn.innerHTML = oldText, 2000);
        }

    </script>
</body>
</html>
